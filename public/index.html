<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Livros</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <div class="container">
    <h1>Cadastro de Livros</h1>
    <form id="formLivro">
      <input type="text" id="titulo" placeholder="Título" required />
      <input type="text" id="autor" placeholder="Autor" required />
      <input type="number" id="ano" placeholder="Ano" required />
      <button type="submit">Cadastrar Livro</button>
    </form>

    <h2>Livros Cadastrados</h2>
    <div id="listaLivros"></div>
  </div>
  <script>
    const form = document.getElementById('formLivro');

    // Função para cadastrar livro
    async function cadastrarLivro(event) {
      event.preventDefault();

      const livro = {
        titulo: document.getElementById('titulo').value,
        autor: document.getElementById('autor').value,
        ano: parseInt(document.getElementById('ano').value),
      };

      const response = await fetch('http://localhost:3000/livros', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(livro),
      });

      if (response.ok) {
        console.log('Livro cadastrado com sucesso!');
        form.reset();
        atualizarListaDeLivros();
      } else {
        console.error('Falha ao cadastrar livro.');
      }
    }

    // Função para exibir a lista de livros
    async function atualizarListaDeLivros() {
      const response = await fetch('http://localhost:3000/livros');
      const livros = await response.json();
      const listaLivros = document.getElementById('listaLivros');

      listaLivros.innerHTML = '';

      livros.forEach((livro) => {
        const div = document.createElement('div');
        div.className = 'livro-item';

        div.innerHTML = `
          <div>
            <strong>${livro.titulo}</strong> - ${livro.autor} (${livro.ano})
          </div>
          <div class="livro-actions">
            <button class="btn btn-editar" onclick="editarLivro('${livro._id}')">Alterar</button>
            <button class="btn btn-excluir" onclick="excluirLivro('${livro._id}')">Excluir</button>
          </div>
        `;
        listaLivros.appendChild(div);
      });
    }

    // Função para editar livro
    async function editarLivro(id) {
      const novoTitulo = prompt("Novo título:");
      const novoAutor = prompt("Novo autor:");
      const novoAno = prompt("Novo ano:");

      if (novoTitulo && novoAutor && novoAno) {

        // Validação de Ano
        const anoNumerico = parseInt(novoAno);

        // Verifica se o resultado da conversão é NaN (Não é um Número)
        if (isNaN(anoNumerico) || anoNumerico <= 0) {
          alert("Erro: Por favor, insira um ano válido. Use apenas números positivos.");
          return;
        }

        const livroAtualizado = {
          titulo: novoTitulo,
          autor: novoAutor,
          ano: anoNumerico, // Variável convertida e validada
        };

        await fetch(`http://localhost:3000/livros/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(livroAtualizado),
        });
        atualizarListaDeLivros();
      }
    }

    // Função para excluir livro
    async function excluirLivro(id) {
      if (confirm('Tem certeza que deseja excluir este livro?')) {
        await fetch(`http://localhost:3000/livros/${id}`, {
          method: 'DELETE',
        });
        atualizarListaDeLivros();
      }
    }

    // Vincular o evento de submit do formulário à função de cadastro
    form.addEventListener('submit', cadastrarLivro);

    // Carregar a lista de livros ao carregar a página
    window.onload = atualizarListaDeLivros;
  </script>
</body>

</html>